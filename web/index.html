<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Financial RAG ‚Äî S&P 500 Analytics Platform</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="browser-frame">
      <div class="browser-top">
        <div class="tabs">
          <div class="tab active" data-tab="rag">Financial RAG</div>
          <div class="tab" data-tab="insights">Insights</div>
          <div class="tab" data-tab="sp500">S&P 500 Analytics</div>
          <div class="tab" data-tab="sp500-chat">S&P 500 Chat</div>
          <div class="tab" data-tab="upload">Upload</div>
        </div>
        <div class="address-toolbar">
          <button class="icon-btn" title="Back">‚óÄ</button>
          <button class="icon-btn" title="Forward">‚ñ∂</button>
          <button class="icon-btn" title="Reload">‚ü≥</button>
          <div class="address-bar">http://localhost:8000/</div>
          <div class="toolbar-actions"><button class="icon-btn">‚öô</button></div>
        </div>
      </div>

      <div class="browser-content">
        <!-- Financial RAG Tab -->
        <div id="tab-rag" class="tab-content">
          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <h1 class="card-title">Financial RAG ‚Äî S&P 500</h1>
                <p class="card-subtitle">Ask questions about S&P 500 companies using AI</p>
              </div>
              
              <h3>Quick Company Links</h3>
              <div id="sp500-companies-list" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:16px">
                <p class="loading" style="grid-column:1/-1">Loading companies...</p>
              </div>
              
              <label for="question">Your Question</label>
              <textarea id="question" placeholder="What are the top S&P 500 companies? Tell me about Apple. Show me Tesla performance.">What are the top S&P 500 companies?</textarea>
              <button id="ask" class="mt-4">Ask Question</button>
              
              <h2>Answer</h2>
              <pre id="answer" class="loading">(waiting)</pre>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Financial Plot</h2>
                <p class="card-subtitle">Visual analysis of metrics and trends</p>
              </div>
              
              <!-- Auto-refresh controls -->
              <div id="plot-controls" style="display:flex;gap:12px;align-items:center;margin-bottom:12px;padding:10px;background:#f0f4ff;border-radius:8px;flex-wrap:wrap">
                <label style="display:flex;align-items:center;gap:6px;font-size:13px">
                  <input type="checkbox" id="auto-refresh-plot" />
                  Auto-refresh
                </label>
                <select id="refresh-interval" style="padding:6px 10px;border-radius:6px;border:1px solid #cbd5e1;font-size:13px">
                  <option value="60000">Every 1 min</option>
                  <option value="300000" selected>Every 5 min</option>
                  <option value="900000">Every 15 min</option>
                </select>
                <button id="manual-refresh-plot" style="padding:6px 12px;background:#4f46e5;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px">‚ü≥ Refresh Now</button>
                <span id="last-update-time" style="font-size:11px;color:#6b7280;margin-left:auto">Last update: --</span>
              </div>
              
              <div id="plot-section">
                <p class="loading">Plot will appear here when you ask about financial metrics...</p>
              </div>
            </div>
          </div>
          
          <!-- Live Market Trend Section -->
          <div class="card mt-4" style="margin-top:20px">
            <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
              <div>
                <h2 class="card-title" style="display:flex;align-items:center;gap:8px">
                  <span style="color:#ef4444;font-size:12px">üî¥ LIVE</span>
                  S&P 500 Market Trend
                </h2>
                <p class="card-subtitle">Real-time index performance from Yahoo Finance</p>
              </div>
              <div style="text-align:right">
                <div id="sp500-live-price" style="font-size:28px;font-weight:bold;color:#1e40af">--</div>
                <div id="sp500-live-change" style="font-size:14px;color:#6b7280">-- (--)</div>
              </div>
            </div>
            
            <!-- Live Stats Row -->
            <div id="sp500-live-stats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin:16px 0;padding:12px;background:#f8fafc;border-radius:8px">
              <div style="text-align:center">
                <div style="font-size:11px;color:#6b7280;text-transform:uppercase">Open</div>
                <div id="stat-open" style="font-size:16px;font-weight:600">--</div>
              </div>
              <div style="text-align:center">
                <div style="font-size:11px;color:#6b7280;text-transform:uppercase">High</div>
                <div id="stat-high" style="font-size:16px;font-weight:600;color:#059669">--</div>
              </div>
              <div style="text-align:center">
                <div style="font-size:11px;color:#6b7280;text-transform:uppercase">Low</div>
                <div id="stat-low" style="font-size:16px;font-weight:600;color:#dc2626">--</div>
              </div>
              <div style="text-align:center">
                <div style="font-size:11px;color:#6b7280;text-transform:uppercase">Prev Close</div>
                <div id="stat-prev-close" style="font-size:16px;font-weight:600">--</div>
              </div>
              <div style="text-align:center">
                <div style="font-size:11px;color:#6b7280;text-transform:uppercase">52W High</div>
                <div id="stat-52w-high" style="font-size:16px;font-weight:600;color:#059669">--</div>
              </div>
              <div style="text-align:center">
                <div style="font-size:11px;color:#6b7280;text-transform:uppercase">52W Low</div>
                <div id="stat-52w-low" style="font-size:16px;font-weight:600;color:#dc2626">--</div>
              </div>
            </div>
            
            <!-- Chart Controls -->
            <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center">
              <button class="market-range-btn active" data-range="1d" style="padding:6px 12px;border:1px solid #e5e7eb;border-radius:6px;background:#4f46e5;color:white;cursor:pointer;font-size:12px">1D</button>
              <button class="market-range-btn" data-range="5d" style="padding:6px 12px;border:1px solid #e5e7eb;border-radius:6px;background:white;cursor:pointer;font-size:12px">5D</button>
              <button class="market-range-btn" data-range="1mo" style="padding:6px 12px;border:1px solid #e5e7eb;border-radius:6px;background:white;cursor:pointer;font-size:12px">1M</button>
              <button class="market-range-btn" data-range="3mo" style="padding:6px 12px;border:1px solid #e5e7eb;border-radius:6px;background:white;cursor:pointer;font-size:12px">3M</button>
              <button class="market-range-btn" data-range="1y" style="padding:6px 12px;border:1px solid #e5e7eb;border-radius:6px;background:white;cursor:pointer;font-size:12px">1Y</button>
              <span style="margin-left:auto;font-size:11px;color:#6b7280" id="market-last-update">Last update: --</span>
              <button id="refresh-market-btn" style="padding:6px 12px;background:#059669;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px">‚ü≥ Refresh</button>
            </div>
            
            <!-- Live Chart -->
            <div style="height:300px;position:relative">
              <canvas id="sp500-live-chart"></canvas>
            </div>
          </div>
        </div>

        <!-- Insights Tab -->
        <div id="tab-insights" class="tab-content hidden">
          <div class="card">
            <div class="card-header">
              <h1 class="card-title">Financial Insights Dashboard</h1>
              <p class="card-subtitle">Analytics and trends from your financial data</p>
            </div>
            
            <div id="insights-summary">
              <p class="loading">Loading insights...</p>
            </div>
          </div>
          
          <div id="insights-charts">
            <div class="card mt-4">
              <h2>Revenue Leaders</h2>
              <div class="table-wrapper">
                <div id="revenue-leaders"></div>
              </div>
            </div>
            
            <div class="card mt-4">
              <h2>Profitability Analysis</h2>
              <div class="table-wrapper">
                <div id="profitability-metrics"></div>
              </div>
            </div>
            
            <div class="card mt-4">
              <h2>Company Comparison</h2>
              <div class="table-wrapper">
                <div id="company-comparison"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- S&P 500 Analytics Tab -->
        <div id="tab-sp500" class="tab-content hidden">
          <div class="card mb-4">
            <div class="card-header">
              <h1 class="card-title">S&P 500 Historical Analytics</h1>
              <p class="card-subtitle">Interactive visualizations and analysis of 150+ years of S&P 500 data</p>
            </div>
            
            <div style="display:flex;gap:var(--space-4);margin-bottom:var(--space-4);flex-wrap:wrap;align-items:flex-end;padding:16px;background:#f8fafc;border-radius:8px">
              <div>
                <label for="sp500-start-date" style="font-size:12px;color:#64748b">Start Date</label>
                <input type="date" id="sp500-start-date" style="display:block;padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;margin-top:4px" />
              </div>
              <div>
                <label for="sp500-end-date" style="font-size:12px;color:#64748b">End Date</label>
                <input type="date" id="sp500-end-date" style="display:block;padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;margin-top:4px" />
              </div>
              <div>
                <label style="font-size:12px;color:#64748b">Metrics to Display</label>
                <div id="metric-checkboxes" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
                  <label style="font-weight:normal;display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="chk-sp500" value="sp500" checked /> S&P 500</label>
                  <label style="font-weight:normal;display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="chk-dividend" value="dividend" /> Dividend</label>
                  <label style="font-weight:normal;display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="chk-earnings" value="earnings" /> Earnings</label>
                  <label style="font-weight:normal;display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="chk-real_price" value="real_price" /> Real Price</label>
                  <label style="font-weight:normal;display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="chk-pe10" value="pe10" /> PE10</label>
                </div>
              </div>
              <button id="sp500-refresh" class="btn-accent" style="padding:10px 20px;margin-left:auto">üîÑ Refresh Charts</button>
            </div>
          </div>
          
          <!-- Market Insights Panel -->
          <div id="market-insights-panel" class="card mb-4" style="background:linear-gradient(135deg,#1e3a5f 0%,#2d5a87 100%);color:white">
            <div class="card-header" style="border-bottom:1px solid rgba(255,255,255,0.2)">
              <h2 class="card-title" style="color:white;display:flex;align-items:center;gap:8px">
                <span>üìä</span> Market Intelligence
              </h2>
              <p class="card-subtitle" style="color:rgba(255,255,255,0.7)">AI-computed insights based on historical data</p>
            </div>
            
            <!-- Key Metrics Row -->
            <div id="insights-metrics" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin:20px 0">
              <div class="insight-metric" style="text-align:center;padding:16px;background:rgba(255,255,255,0.1);border-radius:8px">
                <div style="font-size:11px;text-transform:uppercase;opacity:0.7;margin-bottom:4px">Trend Score</div>
                <div id="trend-score" style="font-size:32px;font-weight:bold">--</div>
                <div id="trend-score-label" style="font-size:12px;opacity:0.8">Loading...</div>
              </div>
              <div class="insight-metric" style="text-align:center;padding:16px;background:rgba(255,255,255,0.1);border-radius:8px">
                <div style="font-size:11px;text-transform:uppercase;opacity:0.7;margin-bottom:4px">Market Regime</div>
                <div id="market-regime" style="font-size:24px;font-weight:bold">--</div>
                <div id="regime-desc" style="font-size:12px;opacity:0.8">Loading...</div>
              </div>
              <div class="insight-metric" style="text-align:center;padding:16px;background:rgba(255,255,255,0.1);border-radius:8px">
                <div style="font-size:11px;text-transform:uppercase;opacity:0.7;margin-bottom:4px">Valuation</div>
                <div id="valuation-status" style="font-size:24px;font-weight:bold">--</div>
                <div id="pe-info" style="font-size:12px;opacity:0.8">PE10: --</div>
              </div>
              <div class="insight-metric" style="text-align:center;padding:16px;background:rgba(255,255,255,0.1);border-radius:8px">
                <div style="font-size:11px;text-transform:uppercase;opacity:0.7;margin-bottom:4px">Volatility</div>
                <div id="volatility-value" style="font-size:24px;font-weight:bold">--%</div>
                <div id="volatility-percentile" style="font-size:12px;opacity:0.8">Percentile: --</div>
              </div>
            </div>
            
            <!-- Returns Row -->
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px">
              <div style="text-align:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:6px">
                <div style="font-size:11px;text-transform:uppercase;opacity:0.6">1Y Return</div>
                <div id="return-1y" style="font-size:20px;font-weight:600">--%</div>
              </div>
              <div style="text-align:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:6px">
                <div style="font-size:11px;text-transform:uppercase;opacity:0.6">5Y CAGR</div>
                <div id="return-5y" style="font-size:20px;font-weight:600">--%</div>
              </div>
              <div style="text-align:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:6px">
                <div style="font-size:11px;text-transform:uppercase;opacity:0.6">10Y CAGR</div>
                <div id="return-10y" style="font-size:20px;font-weight:600">--%</div>
              </div>
            </div>
            
            <!-- Summary Text -->
            <div id="insights-summary-text" style="padding:16px;background:rgba(0,0,0,0.2);border-radius:8px;font-size:14px;line-height:1.6">
              <p style="margin:0">Loading market insights...</p>
            </div>
            
            <!-- Warnings & Opportunities -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px">
              <div id="insights-warnings" style="padding:12px;background:rgba(239,68,68,0.2);border-radius:8px;display:none">
                <div style="font-weight:600;margin-bottom:8px">‚ö†Ô∏è Risk Warnings</div>
                <ul id="warnings-list" style="margin:0;padding-left:20px;font-size:13px"></ul>
              </div>
              <div id="insights-opportunities" style="padding:12px;background:rgba(16,185,129,0.2);border-radius:8px;display:none">
                <div style="font-weight:600;margin-bottom:8px">üí° Opportunities</div>
                <ul id="opportunities-list" style="margin:0;padding-left:20px;font-size:13px"></ul>
              </div>
            </div>
          </div>
          
          <!-- Summary Metrics -->
          <div id="sp500-summary" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:20px">
            <div class="metric-card" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">
              <h3>Latest S&P 500</h3>
              <div class="value" id="latest-sp500">-</div>
            </div>
            <div class="metric-card" style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)">
              <h3>Date Range</h3>
              <div class="value" style="font-size:14px" id="date-range">-</div>
            </div>
            <div class="metric-card" style="background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)">
              <h3>Avg PE10</h3>
              <div class="value" id="avg-pe10">-</div>
            </div>
            <div class="metric-card" style="background:linear-gradient(135deg,#fa709a 0%,#fee140 100%)">
              <h3>Max Drawdown</h3>
              <div class="value" id="max-drawdown">-</div>
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
            <div class="chart-container">
              <h3 style="margin:0 0 12px 0">S&P 500 Price History</h3>
              <canvas id="sp500-price-chart"></canvas>
            </div>
            <div class="chart-container">
              <h3 style="margin:0 0 12px 0">Decade Performance (CAGR %)</h3>
              <canvas id="sp500-decade-chart"></canvas>
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
            <div class="chart-container">
              <h3 style="margin:0 0 12px 0">Year-over-Year Growth</h3>
              <canvas id="sp500-yoy-chart"></canvas>
            </div>
            <div class="chart-container">
              <h3 style="margin:0 0 12px 0">Correlation Matrix</h3>
              <div id="correlation-table"></div>
            </div>
          </div>
          
          <!-- Enhanced Decade Table -->
          <div class="card">
            <h3 style="margin:0 0 16px 0">üìÖ Decade-by-Decade Analysis</h3>
            <div class="table-wrapper">
              <table id="decade-detail-table">
                <thead>
                  <tr>
                    <th>Decade</th>
                    <th>CAGR <span title="Compound Annual Growth Rate" style="cursor:help;opacity:0.6">‚ìò</span></th>
                    <th>Total Return</th>
                    <th>Volatility <span title="Annualized standard deviation" style="cursor:help;opacity:0.6">‚ìò</span></th>
                    <th>Max Drawdown <span title="Largest peak-to-trough decline" style="cursor:help;opacity:0.6">‚ìò</span></th>
                  </tr>
                </thead>
                <tbody id="decade-table-body">
                  <tr><td colspan="5" style="text-align:center;padding:20px">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- S&P 500 Chat Tab -->
        <div id="tab-sp500-chat" class="tab-content hidden">
          <!-- Page Header with Data Coverage Indicator -->
          <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
            <div>
              <h1 style="margin-bottom:4px">S&P 500 Smart Chat</h1>
              <p style="margin-bottom:0">Ask questions about S&P 500 data using natural language ‚Ä¢ <span id="chat-last-update" style="color:#6b7280;font-size:12px">Live data loading...</span></p>
            </div>
            <!-- Data Coverage Indicator (Task 7) -->
            <div id="data-coverage-badge" style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:6px;padding:6px 12px;font-size:11px;color:#0369a1;display:flex;align-items:center;gap:6px">
              <span style="width:6px;height:6px;background:#0ea5e9;border-radius:50%;display:inline-block"></span>
              <span>Data: <strong>Historical (1871‚ÄìPresent)</strong></span>
            </div>
          </div>
          
          <!-- Live Market Ticker Bar - US Markets Only -->
          <div id="live-ticker-bar" style="background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);color:white;padding:16px;border-radius:12px;margin-bottom:20px;display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
            <div style="text-align:center">
              <div style="font-size:11px;text-transform:uppercase;opacity:0.6">S&P 500</div>
              <div id="live-sp500-price" style="font-size:28px;font-weight:bold">--</div>
              <div id="live-sp500-change" style="font-size:14px">--</div>
            </div>
            <div style="text-align:center">
              <div style="font-size:11px;text-transform:uppercase;opacity:0.6">DOW JONES</div>
              <div id="live-dow-price" style="font-size:28px;font-weight:bold">--</div>
              <div id="live-dow-change" style="font-size:14px">--</div>
            </div>
            <div style="text-align:center">
              <div style="font-size:11px;text-transform:uppercase;opacity:0.6">NASDAQ</div>
              <div id="live-nasdaq-price" style="font-size:28px;font-weight:bold">--</div>
              <div id="live-nasdaq-change" style="font-size:14px">--</div>
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
            <!-- Left Column: Input & Quick Questions -->
            <div style="border-right:1px solid #e5e7eb;padding-right:24px">
              <h2 style="font-size:16px;margin-bottom:12px;margin-top:0;display:flex;align-items:center;gap:8px">
                <span style="font-size:18px">üí¨</span> Ask a Question
              </h2>
              
              <!-- Improved Input Box (Task 4) -->
              <div style="position:relative">
                <textarea id="sp500-question" 
                  placeholder="Try asking: 'What has been the average annual return over the last 30 years?' or 'How does current PE10 compare to historical averages?'"
                  style="width:100%;min-height:80px;max-height:200px;border-radius:10px;border:2px solid #e5e7eb;padding:14px;font-family:inherit;font-size:14px;resize:none;transition:border-color 0.2s,box-shadow 0.2s;line-height:1.5"
                ></textarea>
                <div style="position:absolute;bottom:10px;right:10px;font-size:11px;color:#9ca3af">
                  <kbd style="background:#f3f4f6;padding:2px 6px;border-radius:4px;border:1px solid #e5e7eb">Enter</kbd> to send
                </div>
              </div>
              
              <button id="sp500-ask-btn" style="width:100%;margin-top:10px;display:flex;align-items:center;justify-content:center;gap:8px;padding:14px;font-size:15px;font-weight:600;border-radius:10px;background:linear-gradient(135deg,#0c4a6e 0%,#0369a1 100%);color:white;border:none;cursor:pointer;transition:all 0.2s">
                <span id="ask-btn-icon">üîç</span> <span id="ask-btn-text">Analyze</span>
              </button>
              
              <!-- Quick Questions with Selection State (Task 3) -->
              <h2 style="font-size:14px;margin-top:24px;margin-bottom:12px;color:#64748b;font-weight:500">
                Quick Questions
              </h2>
              <div id="quick-questions-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <button class="quick-question" data-q="What is the current S&P 500 trend?" style="padding:12px 10px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;cursor:pointer;text-align:left;font-size:13px;transition:all 0.15s;display:flex;align-items:center;gap:8px">
                  <span style="font-size:16px">üìà</span> <span>Current Trend</span>
                </button>
                <button class="quick-question" data-q="Show me year-over-year growth rates" style="padding:12px 10px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;cursor:pointer;text-align:left;font-size:13px;transition:all 0.15s;display:flex;align-items:center;gap:8px">
                  <span style="font-size:16px">üìä</span> <span>YoY Growth</span>
                </button>
                <button class="quick-question" data-q="How volatile is the S&P 500?" style="padding:12px 10px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;cursor:pointer;text-align:left;font-size:13px;transition:all 0.15s;display:flex;align-items:center;gap:8px">
                  <span style="font-size:16px">‚ö°</span> <span>Volatility Analysis</span>
                </button>
                <button class="quick-question" data-q="What are the correlations with other metrics?" style="padding:12px 10px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;cursor:pointer;text-align:left;font-size:13px;transition:all 0.15s;display:flex;align-items:center;gap:8px">
                  <span style="font-size:16px">üîó</span> <span>Correlations</span>
                </button>
                <button class="quick-question" data-q="Compare performance across decades" style="padding:12px 10px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;cursor:pointer;text-align:left;font-size:13px;transition:all 0.15s;display:flex;align-items:center;gap:8px">
                  <span style="font-size:16px">üìÖ</span> <span>Decade Comparison</span>
                </button>
                <button class="quick-question" data-q="What is the PE10 valuation today?" style="padding:12px 10px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;cursor:pointer;text-align:left;font-size:13px;transition:all 0.15s;display:flex;align-items:center;gap:8px">
                  <span style="font-size:16px">üí∞</span> <span>Valuation (PE10)</span>
                </button>
              </div>
            </div>
            
            <!-- Right Column: Analysis Response & Charts -->
            <div style="padding-left:4px">
              <h2 style="font-size:16px;margin-bottom:12px;margin-top:0;display:flex;align-items:center;gap:8px">
                <span style="font-size:18px">ü§ñ</span> Analysis
              </h2>
              
              <!-- Conversation History Container (Task 1 & 2) -->
              <div id="sp500-conversation" style="background:#f8fafc;border-radius:12px;border:1px solid #e2e8f0;min-height:280px;max-height:400px;overflow-y:auto;padding:16px">
                <!-- Empty State -->
                <div id="sp500-empty-state" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:240px;color:#64748b;text-align:center">
                  <div style="font-size:48px;margin-bottom:12px;opacity:0.5">üí°</div>
                  <div style="font-size:14px;font-weight:500;margin-bottom:4px">Ready to analyze S&P 500 data</div>
                  <div style="font-size:13px;color:#94a3b8;max-width:280px">Ask a question above or select a quick question to get started with AI-powered insights.</div>
                </div>
                
                <!-- Response Cards Container (populated by JS) -->
                <div id="sp500-responses"></div>
              </div>
              
              <!-- Suggested Visualization (Task 5) -->
              <div style="margin-top:16px">
                <div style="font-size:12px;color:#64748b;margin-bottom:8px;display:flex;align-items:center;gap:6px">
                  <span>üìä</span> Suggested Visualization
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                  <div style="background:#f9fafb;padding:12px;border-radius:8px;border:1px solid #e5e7eb">
                    <div style="font-size:11px;color:#6b7280;text-transform:uppercase">Chart Type</div>
                    <div id="suggested-chart" style="font-size:15px;font-weight:600;color:#1e293b">Line Chart</div>
                  </div>
                  <div style="background:#f9fafb;padding:12px;border-radius:8px;border:1px solid #e5e7eb">
                    <div style="font-size:11px;color:#6b7280;text-transform:uppercase">Metrics</div>
                    <div id="suggested-metrics" style="font-size:15px;font-weight:600;color:#1e293b">S&P 500</div>
                  </div>
                </div>
              </div>
              
              <!-- Mini Chart with Caption (Task 5) -->
              <div style="margin-top:16px;background:#f9fafb;padding:14px;border-radius:10px;border:1px solid #e5e7eb">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                  <div style="font-size:12px;color:#374151;font-weight:500">S&P 500 Price Trend</div>
                  <div style="font-size:11px;color:#6b7280">Last 5 trading days</div>
                </div>
                <!-- Fixed height container for Chart.js -->
                <div style="position:relative;height:100px;width:100%">
                  <canvas id="chat-mini-chart"></canvas>
                </div>
                <!-- Chart Caption -->
                <div style="font-size:11px;color:#6b7280;margin-top:8px;padding-top:8px;border-top:1px solid #e5e7eb">
                  This chart shows recent intraday price movement. For detailed historical analysis, use the Charts tab.
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Upload Tab -->
        <div id="tab-upload" class="tab-content hidden">
          <h1>Upload Financial Data</h1>
          <p>Upload CSV or Excel files with your financial metrics</p>
          
          <div class="upload-zone" id="upload-zone">
            <input type="file" id="file-input" accept=".csv,.xlsx,.xls" />
            <p style="font-size:48px;margin:0">üìä</p>
            <p><strong>Click to browse</strong> or drag and drop your file here</p>
            <p style="font-size:12px;color:var(--muted)">Supported formats: CSV, Excel (.xlsx, .xls)</p>
          </div>
          
          <div id="upload-preview" class="hidden">
            <h2>Data Preview</h2>
            <div id="preview-info"></div>
            <button id="ingest-btn">Ingest to Database</button>
          </div>
          
          <div id="upload-status"></div>
        </div>
      </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
        <script>
          // Tab switching
          const tabs = document.querySelectorAll('.tab')
          const tabContents = document.querySelectorAll('.tab-content')
          
          tabs.forEach(tab => {
            tab.addEventListener('click', () => {
              const tabName = tab.getAttribute('data-tab')
              
              // Update active tab
              tabs.forEach(t => t.classList.remove('active'))
              tab.classList.add('active')
              
              // Show corresponding content
              tabContents.forEach(content => {
                if (content.id === `tab-${tabName}`) {
                  content.classList.remove('hidden')
                  
                  // Load data when switching to insights
                  if (tabName === 'insights') {
                    loadInsights()
                  }
                  // Load S&P 500 data when switching to sp500 tab
                  if (tabName === 'sp500') {
                    // Set default dates if not set
                    initSP500DateFilters()
                    loadSP500Dashboard()
                  }
                  // Load S&P 500 Chat with live data
                  if (tabName === 'sp500-chat') {
                    initChatTab()
                  }
                } else {
                  content.classList.add('hidden')
                }
              })
            })
          })

          // RAG Tab functionality
          const askBtn = document.getElementById('ask')
          const qEl = document.getElementById('question')
          const answerEl = document.getElementById('answer')
          const plotSectionEl = document.getElementById('plot-section')

          // Load S&P 500 companies list
          async function loadSP500Companies() {
            try {
              const res = await fetch('/api/sp500/companies?limit=20')
              const data = await res.json()
              
              if (data.success && data.companies && data.companies.length > 0) {
                const listEl = document.getElementById('sp500-companies-list')
                let html = ''
                
                data.companies.forEach(company => {
                  html += `<button class="company-btn" onclick="document.getElementById('question').value = '${company.name} (${company.ticker})'; document.getElementById('ask').click();" style="padding:8px;background:#f0f4ff;border:1px solid #cbd5e1;border-radius:6px;cursor:pointer;font-size:12px">
                    <strong>${company.ticker}</strong> ${company.name.substring(0, 20)}...
                  </button>`
                })
                
                listEl.innerHTML = html
              }
            } catch (err) {
              console.error('Error loading companies:', err)
            }
          }
          
          // Load companies on page load
          loadSP500Companies()

          askBtn.onclick = async () => {
            answerEl.textContent = 'Loading...'
            answerEl.classList.add('loading')
            plotSectionEl.innerHTML = '<p class="loading">Generating plot...</p>'
            
            try {
              const question = qEl.value
              
              // Fetch RAG answer
              const res = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: 'web-demo', question: question }),
              })
              
              if (!res.ok) {
                const text = await res.text()
                answerEl.textContent = `HTTP ${res.status} Error:\n${text}`
                answerEl.classList.remove('loading')
                plotSectionEl.innerHTML = '<p class="error">Could not fetch answer</p>'
                return
              }
              
              let data
              try {
                data = await res.json()
              } catch (jsonErr) {
                const text = await res.text()
                answerEl.textContent = `JSON Parse Error:\n${text}`
                answerEl.classList.remove('loading')
                plotSectionEl.innerHTML = '<p class="error">Invalid response format</p>'
                return
              }
              
              answerEl.textContent = JSON.stringify(data, null, 2)
              answerEl.classList.remove('loading')
              
              // Try to fetch plot for financial metrics
              try {
                const plotRes = await fetch('/api/plot', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ user_id: 'web-demo', question: question }),
                })
                
                if (plotRes.ok) {
                  const plotData = await plotRes.json()
                  
                  if (plotData.plot_base64) {
                    const imgSrc = `data:image/png;base64,${plotData.plot_base64}`
                    plotSectionEl.innerHTML = `
                      <div class="plot-container">
                        <img src="${imgSrc}" alt="Financial Plot" />
                        <div class="plot-meta">
                          <strong>${plotData.company}</strong> ‚Äî ${plotData.metric.replace(/_/g, ' ')}<br>
                          Data points: ${plotData.data_points} | Trend: ${plotData.is_trend ? 'Yes' : 'No'}
                        </div>
                      </div>
                    `
                  } else if (plotData.error) {
                    plotSectionEl.innerHTML = `<p class="error">Plot Error: ${plotData.message || 'Unknown error'}</p>`
                  }
                } else {
                  plotSectionEl.innerHTML = '<p class="error">Could not generate plot (check DATABASE_URL)</p>'
                }
              } catch (plotErr) {
                plotSectionEl.innerHTML = `<p class="error">Plot fetch failed: ${plotErr.message}</p>`
              }
              
            } catch (err) {
              answerEl.textContent = 'Network Error: ' + err.message
              answerEl.classList.remove('loading')
              plotSectionEl.innerHTML = `<p class="error">Network error: ${err.message}</p>`
            }
          }

          // ==================== Auto-Refresh Plot Functionality ====================
          let plotRefreshInterval = null
          let lastPlotQuestion = 'S&P 500 trend'  // Default query for auto-refresh
          
          const autoRefreshCheckbox = document.getElementById('auto-refresh-plot')
          const refreshIntervalSelect = document.getElementById('refresh-interval')
          const manualRefreshBtn = document.getElementById('manual-refresh-plot')
          const lastUpdateTimeEl = document.getElementById('last-update-time')
          
          // Function to fetch and update plot only (without RAG answer)
          async function refreshPlotOnly() {
            const question = qEl.value || lastPlotQuestion
            lastPlotQuestion = question
            
            try {
              plotSectionEl.innerHTML = '<p class="loading">Refreshing live data...</p>'
              
              const plotRes = await fetch('/api/plot', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: 'web-demo', question: question }),
              })
              
              if (plotRes.ok) {
                const plotData = await plotRes.json()
                
                if (plotData.plot_base64) {
                  const imgSrc = `data:image/png;base64,${plotData.plot_base64}`
                  const now = new Date()
                  const timeStr = now.toLocaleTimeString()
                  
                  plotSectionEl.innerHTML = `
                    <div class="plot-container">
                      <img src="${imgSrc}" alt="Financial Plot" style="max-width:100%;border-radius:8px" />
                      <div class="plot-meta" style="margin-top:8px;padding:10px;background:#f0f9ff;border-radius:6px;font-size:13px">
                        <strong style="color:#0369a1">${plotData.company}</strong> ‚Äî ${plotData.metric.replace(/_/g, ' ')}<br>
                        <span style="color:#6b7280">Data points: ${plotData.data_points} | Trend: ${plotData.is_trend ? 'üìà Yes' : 'üìä No'}</span><br>
                        <span style="color:#059669;font-size:11px">üî¥ LIVE ‚Ä¢ Updated: ${timeStr}</span>
                      </div>
                    </div>
                  `
                  lastUpdateTimeEl.textContent = `Last update: ${timeStr}`
                  lastUpdateTimeEl.style.color = '#059669'
                } else if (plotData.error) {
                  plotSectionEl.innerHTML = `<p class="error">Plot Error: ${plotData.message || 'Unknown error'}</p>`
                }
              } else {
                plotSectionEl.innerHTML = '<p class="error">Could not refresh plot</p>'
              }
            } catch (err) {
              plotSectionEl.innerHTML = `<p class="error">Refresh failed: ${err.message}</p>`
            }
          }
          
          // Manual refresh button
          manualRefreshBtn.onclick = () => {
            refreshPlotOnly()
          }
          
          // Start/stop auto-refresh
          autoRefreshCheckbox.onchange = () => {
            if (autoRefreshCheckbox.checked) {
              const interval = parseInt(refreshIntervalSelect.value)
              console.log(`[Auto-refresh] Starting with interval: ${interval/1000}s`)
              
              // Refresh immediately, then set interval
              refreshPlotOnly()
              plotRefreshInterval = setInterval(refreshPlotOnly, interval)
              
              lastUpdateTimeEl.style.color = '#059669'
              lastUpdateTimeEl.textContent = 'Auto-refresh: ON'
            } else {
              if (plotRefreshInterval) {
                clearInterval(plotRefreshInterval)
                plotRefreshInterval = null
              }
              lastUpdateTimeEl.style.color = '#6b7280'
              lastUpdateTimeEl.textContent = 'Auto-refresh: OFF'
              console.log('[Auto-refresh] Stopped')
            }
          }
          
          // Update interval when dropdown changes (if already running)
          refreshIntervalSelect.onchange = () => {
            if (autoRefreshCheckbox.checked && plotRefreshInterval) {
              clearInterval(plotRefreshInterval)
              const interval = parseInt(refreshIntervalSelect.value)
              plotRefreshInterval = setInterval(refreshPlotOnly, interval)
              console.log(`[Auto-refresh] Interval changed to: ${interval/1000}s`)
            }
          }
          
          // Load initial plot on page load
          setTimeout(() => {
            refreshPlotOnly()
          }, 1000)

          // ==================== Live S&P 500 Market Chart ====================
          let liveMarketChart = null
          let marketRefreshInterval = null
          let currentMarketRange = '1d'
          
          async function fetchLiveMarketData(range = '1d') {
            try {
              const res = await fetch(`/api/market/live?range=${range}`)
              if (!res.ok) throw new Error('Failed to fetch market data')
              return await res.json()
            } catch (err) {
              console.error('Market data fetch error:', err)
              return null
            }
          }
          
          function updateMarketStats(data) {
            if (!data || !data.quote) return
            
            const quote = data.quote
            const price = quote.regularMarketPrice || quote.price || 0
            const change = quote.regularMarketChange || 0
            const changePct = quote.regularMarketChangePercent || 0
            
            // Update price display
            document.getElementById('sp500-live-price').textContent = price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})
            
            // Update change display with color
            const changeEl = document.getElementById('sp500-live-change')
            const isPositive = change >= 0
            changeEl.textContent = `${isPositive ? '+' : ''}${change.toFixed(2)} (${isPositive ? '+' : ''}${changePct.toFixed(2)}%)`
            changeEl.style.color = isPositive ? '#059669' : '#dc2626'
            
            // Update stats
            document.getElementById('stat-open').textContent = (quote.regularMarketOpen || quote.open || 0).toLocaleString('en-US', {minimumFractionDigits: 2})
            document.getElementById('stat-high').textContent = (quote.regularMarketDayHigh || quote.dayHigh || 0).toLocaleString('en-US', {minimumFractionDigits: 2})
            document.getElementById('stat-low').textContent = (quote.regularMarketDayLow || quote.dayLow || 0).toLocaleString('en-US', {minimumFractionDigits: 2})
            document.getElementById('stat-prev-close').textContent = (quote.regularMarketPreviousClose || quote.previousClose || 0).toLocaleString('en-US', {minimumFractionDigits: 2})
            document.getElementById('stat-52w-high').textContent = (quote.fiftyTwoWeekHigh || 0).toLocaleString('en-US', {minimumFractionDigits: 2})
            document.getElementById('stat-52w-low').textContent = (quote.fiftyTwoWeekLow || 0).toLocaleString('en-US', {minimumFractionDigits: 2})
          }
          
          function updateLiveChart(data) {
            if (!data || !data.history || data.history.length === 0) {
              console.error('No chart data available')
              return
            }
            
            const ctx = document.getElementById('sp500-live-chart').getContext('2d')
            const labels = data.history.map(d => d.time || d.date)
            const prices = data.history.map(d => d.close || d.price)
            
            // Determine trend color
            const firstPrice = prices[0] || 0
            const lastPrice = prices[prices.length - 1] || 0
            const isUp = lastPrice >= firstPrice
            const lineColor = isUp ? '#059669' : '#dc2626'
            const bgColor = isUp ? 'rgba(5, 150, 105, 0.1)' : 'rgba(220, 38, 38, 0.1)'
            
            if (liveMarketChart) {
              liveMarketChart.destroy()
            }
            
            liveMarketChart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [{
                  label: 'S&P 500',
                  data: prices,
                  borderColor: lineColor,
                  backgroundColor: bgColor,
                  borderWidth: 2,
                  fill: true,
                  tension: 0.1,
                  pointRadius: 0,
                  pointHoverRadius: 4,
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                  intersect: false,
                  mode: 'index',
                },
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    callbacks: {
                      label: (ctx) => `$${ctx.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2})}`
                    }
                  }
                },
                scales: {
                  x: {
                    grid: { display: false },
                    ticks: {
                      maxTicksLimit: 8,
                      font: { size: 10 }
                    }
                  },
                  y: {
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    ticks: {
                      callback: (value) => value.toLocaleString('en-US'),
                      font: { size: 10 }
                    }
                  }
                }
              }
            })
            
            // Update timestamp
            const now = new Date().toLocaleTimeString()
            document.getElementById('market-last-update').textContent = `Last update: ${now}`
          }
          
          async function refreshLiveMarket() {
            const data = await fetchLiveMarketData(currentMarketRange)
            if (data) {
              updateMarketStats(data)
              updateLiveChart(data)
            }
          }
          
          // Range button handlers
          document.querySelectorAll('.market-range-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              // Update active state
              document.querySelectorAll('.market-range-btn').forEach(b => {
                b.classList.remove('active')
                b.style.background = 'white'
                b.style.color = 'black'
              })
              btn.classList.add('active')
              btn.style.background = '#4f46e5'
              btn.style.color = 'white'
              
              currentMarketRange = btn.dataset.range
              await refreshLiveMarket()
            })
          })
          
          // Manual refresh button
          document.getElementById('refresh-market-btn').onclick = refreshLiveMarket
          
          // Auto-refresh market data every 60 seconds
          function startMarketAutoRefresh() {
            refreshLiveMarket() // Initial load
            marketRefreshInterval = setInterval(refreshLiveMarket, 60000) // Every 60 seconds
          }
          
          // Load market data on page load
          setTimeout(startMarketAutoRefresh, 500)

          // Upload Tab functionality
          const uploadZone = document.getElementById('upload-zone')
          const fileInput = document.getElementById('file-input')
          const uploadPreview = document.getElementById('upload-preview')
          const previewInfo = document.getElementById('preview-info')
          const uploadStatus = document.getElementById('upload-status')
          const ingestBtn = document.getElementById('ingest-btn')
          
          let currentFile = null

          uploadZone.onclick = () => fileInput.click()
          
          uploadZone.ondragover = (e) => {
            e.preventDefault()
            uploadZone.classList.add('drag-over')
          }
          
          uploadZone.ondragleave = () => {
            uploadZone.classList.remove('drag-over')
          }
          
          uploadZone.ondrop = (e) => {
            e.preventDefault()
            uploadZone.classList.remove('drag-over')
            const file = e.dataTransfer.files[0]
            if (file) {
              handleFileUpload(file)
            }
          }
          
          fileInput.onchange = (e) => {
            const file = e.target.files[0]
            if (file) {
              handleFileUpload(file)
            }
          }
          
          async function handleFileUpload(file) {
            currentFile = file
            uploadStatus.innerHTML = '<p class="loading">Uploading and parsing file...</p>'
            
            try {
              const formData = new FormData()
              formData.append('file', file)
              
              const res = await fetch('/api/upload/file', {
                method: 'POST',
                body: formData
              })
              
              const data = await res.json()
              
              if (!res.ok) {
                uploadStatus.innerHTML = `<p class="error">${data.error}</p>`
                return
              }
              
              // Show preview
              const preview = data.preview
              let html = `<div class="success">File parsed: ${data.filename}</div>`
              html += `<p><strong>Rows:</strong> ${preview.row_count} | <strong>Columns:</strong> ${preview.columns.length}</p>`
              html += `<p><strong>Detected Schema:</strong> ${Object.keys(preview.detected_schema).join(', ') || 'None'}</p>`
              html += '<h3>Sample Data:</h3>'
              html += '<table><thead><tr>'
              
              preview.columns.forEach(col => {
                html += `<th>${col}</th>`
              })
              html += '</tr></thead><tbody>'
              
              preview.sample_rows.slice(0, 5).forEach(row => {
                html += '<tr>'
                preview.columns.forEach(col => {
                  html += `<td>${row[col] !== null ? row[col] : ''}</td>`
                })
                html += '</tr>'
              })
              html += '</tbody></table>'
              
              previewInfo.innerHTML = html
              uploadPreview.classList.remove('hidden')
              uploadStatus.innerHTML = ''
              
            } catch (err) {
              uploadStatus.innerHTML = `<p class="error">Upload failed: ${err.message}</p>`
            }
          }
          
          ingestBtn.onclick = async () => {
            if (!currentFile) return
            
            uploadStatus.innerHTML = '<p class="loading">Ingesting data into database...</p>'
            
            try {
              const formData = new FormData()
              formData.append('file', currentFile)
              
              const res = await fetch('/api/upload/ingest', {
                method: 'POST',
                body: formData
              })
              
              const data = await res.json()
              
              if (!res.ok) {
                uploadStatus.innerHTML = `<p class="error">${data.error}</p>`
                return
              }
              
              uploadStatus.innerHTML = `
                <div class="success">
                  <strong>‚úì Data ingested successfully!</strong><br>
                  Rows inserted: ${data.rows_inserted}<br>
                  Companies: ${data.companies.join(', ')}
                </div>
              `
              
              // Reset form
              setTimeout(() => {
                uploadPreview.classList.add('hidden')
                currentFile = null
                fileInput.value = ''
              }, 2000)
              
            } catch (err) {
              uploadStatus.innerHTML = `<p class="error">Ingestion failed: ${err.message}</p>`
            }
          }

          // Insights Tab functionality
          async function loadInsights() {
            const summaryEl = document.getElementById('insights-summary')
            const revenueEl = document.getElementById('revenue-leaders')
            const profitEl = document.getElementById('profitability-metrics')
            const comparisonEl = document.getElementById('company-comparison')
            
            try {
              // Load summary
              const summaryRes = await fetch('/api/insights/summary')
              const summary = await summaryRes.json()
              
              // API returns: { meta: {...}, data: [...], summary: {status, total_companies, record_count, ...} }
              if (summary.summary?.status === 'error') {
                summaryEl.innerHTML = `<p class="error">${summary.errors?.join(', ') || 'Error loading data'}</p>`
              } else {
                const dateRange = summary.meta?.date_range || {}
                summaryEl.innerHTML = `
                  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
                    <div class="metric-card">
                      <h3>Companies</h3>
                      <div class="value">${summary.summary?.total_companies || summary.data?.length || 0}</div>
                    </div>
                    <div class="metric-card" style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)">
                      <h3>Data Points</h3>
                      <div class="value">${summary.summary?.record_count || 0}</div>
                    </div>
                    <div class="metric-card" style="background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)">
                      <h3>Date Range</h3>
                      <div class="value" style="font-size:14px">${dateRange.start || 'N/A'} - ${dateRange.end || 'N/A'}</div>
                    </div>
                  </div>
                `
              }
              
              // Load revenue leaders
              const revenueRes = await fetch('/api/insights/revenue-leaders?limit=10')
              const revenueData = await revenueRes.json()
              
              // API returns: { meta: {...}, data: [{ticker, name, sector, revenue, market_cap}], summary: {...} }
              if (revenueData.data && revenueData.data.length > 0) {
                let html = '<table><thead><tr><th>Ticker</th><th>Name</th><th>Sector</th><th>Market Cap</th></tr></thead><tbody>'
                revenueData.data.forEach(item => {
                  const marketCap = item.market_cap ? formatCurrency(item.market_cap) : 'N/A'
                  html += `<tr>
                    <td><strong>${item.ticker || 'N/A'}</strong></td>
                    <td>${item.name || 'N/A'}</td>
                    <td>${item.sector || 'N/A'}</td>
                    <td>${marketCap}</td>
                  </tr>`
                })
                html += '</tbody></table>'
                revenueEl.innerHTML = html
              } else {
                revenueEl.innerHTML = '<p class="loading">No data available</p>'
              }
              
              // Load profitability (S&P 500 growth analysis)
              const profitRes = await fetch('/api/insights/profitability?limit=20')
              const profitData = await profitRes.json()
              
              // API returns: { data: [{rank, period, return_pct, growth}], summary: {...} }
              if (profitData.data && profitData.data.length > 0) {
                let html = '<table><thead><tr><th>Period</th><th>Growth</th><th>Return %</th></tr></thead><tbody>'
                profitData.data.forEach(item => {
                  const returnPct = item.return_pct ? item.return_pct.toFixed(2) + '%' : 'N/A'
                  const growthClass = (item.return_pct || 0) >= 0 ? 'positive' : 'negative'
                  html += `<tr>
                    <td><strong>${item.period || 'N/A'}</strong></td>
                    <td><span class="status-badge ${growthClass}">${item.growth || 'N/A'}</span></td>
                    <td class="${growthClass}">${returnPct}</td>
                  </tr>`
                })
                html += '</tbody></table>'
                profitEl.innerHTML = html
              } else {
                profitEl.innerHTML = '<p class="loading">No data available</p>'
              }
              
              // Load comparison (sector comparison)
              const comparisonRes = await fetch('/api/insights/comparison')
              const comparisonData = await comparisonRes.json()
              
              // API returns: { data: [{rank, ticker, name, sector, performance}], summary: {...} }
              if (comparisonData.data && comparisonData.data.length > 0) {
                let html = '<table><thead><tr><th>Rank</th><th>Ticker</th><th>Name</th><th>Sector</th><th>Performance</th></tr></thead><tbody>'
                comparisonData.data.forEach(item => {
                  html += `<tr>
                    <td>${item.rank || 'N/A'}</td>
                    <td><strong>${item.ticker || 'N/A'}</strong></td>
                    <td>${item.name || 'N/A'}</td>
                    <td>${item.sector || 'N/A'}</td>
                    <td><span class="status-badge ok">${item.performance || 'N/A'}</span></td>
                  </tr>`
                })
                html += '</tbody></table>'
                comparisonEl.innerHTML = html
              } else {
                comparisonEl.innerHTML = '<p class="loading">No data available</p>'
              }
              
            } catch (err) {
              summaryEl.innerHTML = `<p class="error">Failed to load insights: ${err.message}</p>`
            }
          }
          
          // Helper function for currency formatting
          function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) return 'N/A'
            const num = parseFloat(value)
            if (num >= 1e12) return '$' + (num / 1e12).toFixed(2) + 'T'
            if (num >= 1e9) return '$' + (num / 1e9).toFixed(2) + 'B'
            if (num >= 1e6) return '$' + (num / 1e6).toFixed(2) + 'M'
            if (num >= 1e3) return '$' + (num / 1e3).toFixed(2) + 'K'
            return '$' + num.toFixed(2)
          }

          // ==================== S&P 500 Dashboard ====================
          let priceChart = null
          let decadeChart = null
          let yoyChart = null
          let sp500FiltersInitialized = false
          
          function initSP500DateFilters() {
            if (sp500FiltersInitialized) return
            sp500FiltersInitialized = true
            
            const startDateEl = document.getElementById('sp500-start-date')
            const endDateEl = document.getElementById('sp500-end-date')
            
            // Set default: last 20 years
            const today = new Date()
            const twentyYearsAgo = new Date(today.getFullYear() - 20, today.getMonth(), today.getDate())
            
            if (startDateEl && !startDateEl.value) {
              startDateEl.value = twentyYearsAgo.toISOString().split('T')[0]
            }
            if (endDateEl && !endDateEl.value) {
              endDateEl.value = today.toISOString().split('T')[0]
            }
          }
          
          async function loadSP500Dashboard() {
            try {
              // Load market insights first (prominent display)
              await loadMarketInsights()
              
              // Load summary
              const summaryRes = await fetch('/api/sp500/summary')
              const summaryData = await summaryRes.json()
              
              // API returns: { meta: {...}, data: [], summary: {status, record_count, latest_values, statistics, ...} }
              if (summaryData.summary?.status === 'ok') {
                const latestSp500 = summaryData.summary?.latest_values?.sp500
                document.getElementById('latest-sp500').textContent = latestSp500 ? latestSp500.toFixed(2) : '-'
                
                const dateRange = summaryData.meta?.date_range || {}
                document.getElementById('date-range').textContent = 
                  `${dateRange.start || '-'} to ${dateRange.end || '-'}`
                
                const avgPe10 = summaryData.summary?.statistics?.pe10?.avg
                document.getElementById('avg-pe10').textContent = avgPe10 ? avgPe10.toFixed(2) : '-'
              }
              
              // Load time series for price chart
              await loadPriceChart()
              
              // Load decade performance chart
              await loadDecadeChart()
              
              // Load enhanced decade table
              await loadEnhancedDecadeTable()
              
              // Load YoY growth
              await loadYoYChart()
              
              // Load correlations (enhanced)
              await loadCorrelations()
              
            } catch (err) {
              console.error('Failed to load S&P 500 dashboard:', err)
            }
          }
          
          // Helper to get selected metrics and date range
          function getFilterParams() {
            const startDate = document.getElementById('sp500-start-date')?.value || ''
            const endDate = document.getElementById('sp500-end-date')?.value || ''
            const metrics = []
            document.querySelectorAll('#metric-checkboxes input[type="checkbox"]:checked').forEach(chk => {
              metrics.push(chk.value)
            })
            return { startDate, endDate, metrics: metrics.length > 0 ? metrics : ['sp500'] }
          }
          
          // Metric colors for multi-line chart
          const metricColors = {
            sp500: { border: '#2563eb', bg: 'rgba(37, 99, 235, 0.1)' },
            dividend: { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },
            earnings: { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
            real_price: { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },
            pe10: { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' }
          }
          
          const metricLabels = {
            sp500: 'S&P 500',
            dividend: 'Dividend',
            earnings: 'Earnings',
            real_price: 'Real Price',
            pe10: 'PE10'
          }
          
          async function loadPriceChart() {
            const { startDate, endDate, metrics } = getFilterParams()
            
            // Build query string with filters including selected metrics
            let url = '/api/sp500/timeseries?limit=500'
            if (startDate) url += `&start_date=${startDate}`
            if (endDate) url += `&end_date=${endDate}`
            // Always include date in metrics, plus selected metrics
            const metricsParam = ['date', ...metrics].join(',')
            url += `&metrics=${metricsParam}`
            
            const res = await fetch(url)
            const data = await res.json()
            
            // API returns: { meta: {...}, data: [{date, sp500, ...}], summary: {status, ...} }
            if (data.summary?.status !== 'ok' || !data.data || data.data.length === 0) {
              console.log('No price data available:', data)
              return
            }
            
            // Data is already filtered by API, but double-check client-side
            let filteredData = data.data
            if (startDate) {
              filteredData = filteredData.filter(d => d.date >= startDate)
            }
            if (endDate) {
              filteredData = filteredData.filter(d => d.date <= endDate)
            }
            
            // Skip null/undefined values for each metric
            const ctx = document.getElementById('sp500-price-chart').getContext('2d')
            
            if (priceChart) {
              priceChart.destroy()
            }
            
            // Build datasets for each selected metric - properly handle null/undefined
            const datasets = metrics.map(metric => ({
              label: metricLabels[metric] || metric.toUpperCase(),
              data: filteredData.map(d => {
                const val = d[metric]
                // Return null for missing data (Chart.js will skip these points)
                if (val === null || val === undefined || val === '') return null
                const num = parseFloat(val)
                return isNaN(num) ? null : num
              }),
              borderColor: metricColors[metric]?.border || '#6b7280',
              backgroundColor: metricColors[metric]?.bg || 'rgba(107, 114, 128, 0.1)',
              fill: metrics.length === 1,
              tension: 0.4,
              pointRadius: 0,
              borderWidth: 2,
              yAxisID: metric === 'pe10' ? 'y1' : 'y',
              spanGaps: true  // Connect lines across null values
            }))
            
            // Check if PE10 is selected (needs separate axis due to different scale)
            const hasPE10 = metrics.includes('pe10')
            
            priceChart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: filteredData.map(d => d.date),
                datasets: datasets
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                interaction: {
                  mode: 'index',
                  intersect: false
                },
                plugins: {
                  legend: {
                    display: metrics.length > 1,
                    position: 'top'
                  },
                  tooltip: {
                    mode: 'index',
                    intersect: false
                  }
                },
                scales: {
                  x: {
                    display: true,
                    ticks: {
                      maxTicksLimit: 10
                    }
                  },
                  y: {
                    display: true,
                    beginAtZero: false,
                    position: 'left',
                    title: {
                      display: true,
                      text: 'Price / Value'
                    }
                  },
                  y1: {
                    display: hasPE10,
                    beginAtZero: false,
                    position: 'right',
                    grid: {
                      drawOnChartArea: false
                    },
                    title: {
                      display: hasPE10,
                      text: 'PE10 Ratio'
                    }
                  }
                }
              }
            })
          }
          
          async function loadDecadeChart() {
            const { startDate, endDate } = getFilterParams()
            const startYear = startDate ? parseInt(startDate.split('-')[0]) : null
            const endYear = endDate ? parseInt(endDate.split('-')[0]) : null
            
            // Helper to filter decades by date range
            const filterDecades = (data) => {
              if (!startYear && !endYear) return data
              return data.filter(d => {
                const decade = d.decade
                // A decade (e.g., 2000) covers years 2000-2009
                const decadeEnd = decade + 9
                // Include decade if it overlaps with the selected range
                if (startYear && decadeEnd < startYear) return false
                if (endYear && decade > endYear) return false
                return true
              })
            }
            
            // Try enhanced decades first for CAGR data
            try {
              const res = await fetch('/api/sp500/decades-enhanced')
              const response = await res.json()
              
              // Handle analytics_response format: { meta, data: [...], summary }
              if (response.summary?.status === 'ok' && response.data && response.data.length > 0) {
                const filteredData = filterDecades(response.data)
                const ctx = document.getElementById('sp500-decade-chart').getContext('2d')
                
                if (decadeChart) {
                  decadeChart.destroy()
                }
                
                const cagrValues = filteredData.map(d => d.cagr !== undefined ? d.cagr : 0)
                const backgroundColors = cagrValues.map(v => v >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)')
                const borderColors = cagrValues.map(v => v >= 0 ? '#10b981' : '#ef4444')
                
                decadeChart = new Chart(ctx, {
                  type: 'bar',
                  data: {
                    labels: filteredData.map(d => `${d.decade}s`),
                    datasets: [{
                      label: 'CAGR %',
                      data: cagrValues,
                      backgroundColor: backgroundColors,
                      borderColor: borderColors,
                      borderWidth: 1
                    }]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                      legend: {
                        display: false
                      },
                      tooltip: {
                        callbacks: {
                          label: (ctx) => `CAGR: ${ctx.raw.toFixed(2)}%`
                        }
                      }
                    },
                    scales: {
                      y: {
                        beginAtZero: false,
                        ticks: {
                          callback: (value) => value + '%'
                        }
                      }
                    }
                  }
                })
                return
              }
            } catch (e) {
              console.log('Enhanced decades not available for chart, falling back:', e)
            }
            
            // Fallback to basic decades API
            const res = await fetch('/api/sp500/decades')
            const data = await res.json()
            
            // API returns: { meta: {...}, data: [{decade, avg_sp500, min_sp500, max_sp500}], summary: {status, ...} }
            if (data.summary?.status !== 'ok' || !data.data || data.data.length === 0) {
              console.log('No decade data available:', data)
              return
            }
            
            const filteredData = filterDecades(data.data)
            const ctx = document.getElementById('sp500-decade-chart').getContext('2d')
            
            if (decadeChart) {
              decadeChart.destroy()
            }
            
            decadeChart = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: filteredData.map(d => `${d.decade}s`),
                datasets: [{
                  label: 'Avg S&P 500',
                  data: filteredData.map(d => parseFloat(d.avg_sp500) || 0),
                  backgroundColor: 'rgba(147, 51, 234, 0.8)',
                  borderColor: '#9333ea',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                plugins: {
                  legend: {
                    display: false
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true
                  }
                }
              }
            })
          }
          
          async function loadYoYChart() {
            const { startDate, endDate } = getFilterParams()
            const res = await fetch('/api/sp500/yoy-growth')
            const data = await res.json()
            
            // API returns: { meta: {...}, data: [{year, yoy_growth}], summary: {status, ...} }
            if (data.summary?.status !== 'ok' || !data.data || data.data.length === 0) {
              console.log('No YoY growth data available:', data)
              return
            }
            
            // Filter data by selected date range
            let filteredData = data.data
            if (startDate) {
              const startYear = parseInt(startDate.split('-')[0])
              filteredData = filteredData.filter(d => d.year >= startYear)
            }
            if (endDate) {
              const endYear = parseInt(endDate.split('-')[0])
              filteredData = filteredData.filter(d => d.year <= endYear)
            }
            
            const ctx = document.getElementById('sp500-yoy-chart').getContext('2d')
            
            if (yoyChart) {
              yoyChart.destroy()
            }
            
            yoyChart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: filteredData.map(d => d.year),
                datasets: [{
                  label: 'YoY Growth %',
                  data: filteredData.map(d => parseFloat(d.yoy_growth) || 0),
                  borderColor: '#10b981',
                  backgroundColor: 'rgba(16, 185, 129, 0.1)',
                  fill: true,
                  tension: 0.4,
                  pointRadius: 0,
                  borderWidth: 2
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                plugins: {
                  legend: {
                    display: false
                  }
                },
                scales: {
                  x: {
                    display: true,
                    ticks: {
                      maxTicksLimit: 10
                    }
                  },
                  y: {
                    display: true
                  }
                }
              }
            })
          }
          
          async function loadCorrelations() {
            // Try enhanced correlations first
            try {
              const res = await fetch('/api/sp500/correlations-full')
              const response = await res.json()
              
              // Handle analytics_response format: { meta, data: [...], summary }
              if (response.summary?.status === 'ok' && response.data && response.data.length > 0) {
                const tableEl = document.getElementById('correlation-table')
                let html = '<table style="font-size:12px"><thead><tr><th>Metric</th><th>Correlation</th><th>Strength</th></tr></thead><tbody>'
                
                // data is already flat array of {metric, label, correlation, strength}
                response.data.forEach(item => {
                  const corrValue = item.correlation !== undefined ? item.correlation.toFixed(3) : 'N/A'
                  const strength = item.strength || 'Unknown'
                  const strengthColor = strength.includes('Strong') ? '#10b981' : strength === 'Moderate' ? '#f59e0b' : '#6b7280'
                  html += `<tr>
                    <td><strong>${item.label || item.metric.replace(/_/g, ' ').toUpperCase()}</strong></td>
                    <td style="font-family:monospace">${corrValue}</td>
                    <td style="color:${strengthColor};font-weight:600">${strength}</td>
                  </tr>`
                })
                
                html += '</tbody></table>'
                tableEl.innerHTML = html
                return
              }
            } catch (e) {
              console.log('Enhanced correlations not available, falling back:', e)
            }
            
            // Fallback to basic correlations
            const res = await fetch('/api/sp500/correlations')
            const data = await res.json()
            
            if (data.summary?.status !== 'ok' || !data.data || data.data.length === 0) {
              console.log('No correlation data available:', data)
              return
            }
            
            const tableEl = document.getElementById('correlation-table')
            let html = '<table><thead><tr><th>Metric</th><th>Correlation with S&P 500</th></tr></thead><tbody>'
            
            data.data.forEach(item => {
              const corrValue = item.correlation !== undefined && item.correlation !== null 
                ? parseFloat(item.correlation).toFixed(3) 
                : 'N/A'
              html += `<tr>
                <td><strong>${(item.metric || '').replace(/_/g, ' ').toUpperCase()}</strong></td>
                <td>${corrValue}</td>
              </tr>`
            })
            
            html += '</tbody></table>'
            tableEl.innerHTML = html
          }
          
          // ==================== Market Insights Functions ====================
          
          async function loadMarketInsights() {
            try {
              const res = await fetch('/api/sp500/insights')
              const data = await res.json()
              
              // Handle flat response format: { status: 'ok', trend_score: {...}, ... }
              if (data.status !== 'ok') {
                console.log('Insights not available:', data)
                return
              }
              
              // Trend Score (now nested: { score: N, label: 'Strong' })
              const trendScoreObj = data.trend_score || {}
              const trendScore = trendScoreObj.score ?? '--'
              const trendLabel = trendScoreObj.label || (trendScore >= 70 ? 'Strong' : trendScore >= 40 ? 'Moderate' : 'Weak')
              document.getElementById('trend-score').textContent = typeof trendScore === 'number' ? trendScore.toFixed(0) : trendScore
              document.getElementById('trend-score-label').textContent = trendLabel
              
              // Color code trend score
              const trendEl = document.getElementById('trend-score')
              if (trendScore >= 70) trendEl.style.color = '#10b981'
              else if (trendScore >= 40) trendEl.style.color = '#f59e0b'
              else if (typeof trendScore === 'number') trendEl.style.color = '#ef4444'
              
              // Market Regime (nested: { regime: 'Bull', description: '...' })
              const regime = data.market_regime || {}
              document.getElementById('market-regime').textContent = regime.regime || '--'
              document.getElementById('regime-desc').textContent = regime.description || ''
              
              // Color code regime
              const regimeEl = document.getElementById('market-regime')
              const regimeStatus = (regime.regime || '').toLowerCase()
              if (regimeStatus.includes('bull')) regimeEl.style.color = '#10b981'
              else if (regimeStatus.includes('bear')) regimeEl.style.color = '#ef4444'
              else regimeEl.style.color = '#f59e0b'
              
              // Valuation
              const valuation = data.valuation || {}
              document.getElementById('valuation-status').textContent = valuation.status || '--'
              const pe10 = valuation.current_pe10
              document.getElementById('pe-info').textContent = pe10 ? `PE10: ${pe10.toFixed(1)} (${valuation.percentile?.toFixed(0) || '--'}th %ile)` : 'PE10: --'
              
              // Color code valuation
              const valEl = document.getElementById('valuation-status')
              const valStatus = (valuation.status || '').toLowerCase()
              if (valStatus.includes('undervalued') || valStatus.includes('attractive')) valEl.style.color = '#10b981'
              else if (valStatus.includes('overvalued') || valStatus.includes('elevated')) valEl.style.color = '#ef4444'
              else valEl.style.color = '#f59e0b'
              
              // Volatility (keys: '30d', '1y', 'percentile' - values are decimals like 0.5474)
              const volatility = data.volatility || {}
              const vol30d = volatility['30d']
              document.getElementById('volatility-value').textContent = vol30d ? `${(vol30d * 100).toFixed(1)}%` : '--%'
              const volPercentile = volatility.percentile
              document.getElementById('volatility-percentile').textContent = volPercentile ? `${volPercentile.toFixed(0)}th percentile` : 'Percentile: --'
              
              // Returns (keys: '1y', '5y_cagr', '10y_cagr' - values are decimals like 0.1695)
              const returns = data.returns || {}
              document.getElementById('return-1y').textContent = returns['1y'] !== undefined && returns['1y'] !== null ? `${(returns['1y'] * 100).toFixed(1)}%` : '--%'
              document.getElementById('return-5y').textContent = returns['5y_cagr'] !== undefined && returns['5y_cagr'] !== null ? `${(returns['5y_cagr'] * 100).toFixed(1)}%` : '--%'
              document.getElementById('return-10y').textContent = returns['10y_cagr'] !== undefined && returns['10y_cagr'] !== null ? `${(returns['10y_cagr'] * 100).toFixed(1)}%` : '--%'
              
              // Color returns
              ['return-1y', 'return-5y', 'return-10y'].forEach(id => {
                const el = document.getElementById(id)
                const val = parseFloat(el.textContent)
                if (!isNaN(val)) {
                  el.style.color = val >= 0 ? '#10b981' : '#ef4444'
                }
              })
              
              // Max Drawdown (nested: { value: -0.5256, current: 0 } - decimals)
              const drawdown = data.max_drawdown || {}
              const drawdownEl = document.getElementById('max-drawdown')
              if (drawdownEl && drawdown.value !== undefined) {
                drawdownEl.textContent = `${(drawdown.value * 100).toFixed(1)}%`
              }
              
              // Summary Text
              const summaryText = data.summary_text || 'Market insights data loaded.'
              document.getElementById('insights-summary-text').innerHTML = `<p style="margin:0">${summaryText}</p>`
              
              // Warnings
              const warnings = data.warnings || []
              const warningsDiv = document.getElementById('insights-warnings')
              const warningsList = document.getElementById('warnings-list')
              if (warnings.length > 0) {
                warningsDiv.style.display = 'block'
                warningsList.innerHTML = warnings.map(w => `<li>${w}</li>`).join('')
              } else {
                warningsDiv.style.display = 'none'
              }
              
              // Opportunities
              const opportunities = data.opportunities || []
              const oppsDiv = document.getElementById('insights-opportunities')
              const oppsList = document.getElementById('opportunities-list')
              if (opportunities.length > 0) {
                oppsDiv.style.display = 'block'
                oppsList.innerHTML = opportunities.map(o => `<li>${o}</li>`).join('')
              } else {
                oppsDiv.style.display = 'none'
              }
              
            } catch (err) {
              console.error('Failed to load market insights:', err)
            }
          }
          
          async function loadEnhancedDecadeTable() {
            try {
              const { startDate, endDate } = getFilterParams()
              const startYear = startDate ? parseInt(startDate.split('-')[0]) : null
              const endYear = endDate ? parseInt(endDate.split('-')[0]) : null
              
              const res = await fetch('/api/sp500/decades-enhanced')
              const response = await res.json()
              
              // Handle analytics_response format: { meta, data: [...], summary }
              if (response.summary?.status !== 'ok' || !response.data || response.data.length === 0) {
                console.log('Enhanced decades not available:', response)
                return
              }
              
              // Filter decades by date range
              let filteredData = response.data
              if (startYear || endYear) {
                filteredData = response.data.filter(d => {
                  const decade = d.decade
                  const decadeEnd = decade + 9
                  if (startYear && decadeEnd < startYear) return false
                  if (endYear && decade > endYear) return false
                  return true
                })
              }
              
              const tbody = document.getElementById('decade-table-body')
              let html = ''
              
              filteredData.forEach(d => {
                const cagr = d.cagr !== undefined ? `${d.cagr.toFixed(2)}%` : 'N/A'
                const totalReturn = d.total_return !== undefined ? `${d.total_return.toFixed(1)}%` : 'N/A'
                const volatility = d.volatility !== undefined ? `${d.volatility.toFixed(1)}%` : 'N/A'
                const maxDrawdown = d.max_drawdown !== undefined ? `${d.max_drawdown.toFixed(1)}%` : 'N/A'
                
                // Color code CAGR
                const cagrVal = d.cagr !== undefined ? d.cagr : 0
                const cagrColor = cagrVal >= 10 ? '#10b981' : cagrVal >= 5 ? '#f59e0b' : cagrVal >= 0 ? '#6b7280' : '#ef4444'
                
                // Color code drawdown (worse = more red)
                const ddVal = d.max_drawdown !== undefined ? d.max_drawdown : 0
                const ddColor = ddVal <= -40 ? '#ef4444' : ddVal <= -20 ? '#f59e0b' : '#10b981'
                
                html += `<tr>
                  <td><strong>${d.decade}s</strong></td>
                  <td style="color:${cagrColor};font-weight:600">${cagr}</td>
                  <td>${totalReturn}</td>
                  <td>${volatility}</td>
                  <td style="color:${ddColor};font-weight:600">${maxDrawdown}</td>
                </tr>`
              })
              
              tbody.innerHTML = html
              
            } catch (err) {
              console.error('Failed to load enhanced decade table:', err)
            }
          }
          
          // Refresh button handler
          document.getElementById('sp500-refresh')?.addEventListener('click', () => {
            loadSP500Dashboard()
          })
          
          // Auto-refresh when date filters or metric checkboxes change
          document.getElementById('sp500-start-date')?.addEventListener('change', () => {
            loadPriceChart()
            loadYoYChart()
            loadDecadeChart()
            loadEnhancedDecadeTable()
          })
          document.getElementById('sp500-end-date')?.addEventListener('change', () => {
            loadPriceChart()
            loadYoYChart()
            loadDecadeChart()
            loadEnhancedDecadeTable()
          })
          document.querySelectorAll('#metric-checkboxes input[type="checkbox"]').forEach(chk => {
            chk.addEventListener('change', () => {
              loadPriceChart()
            })
          })

          // ==================== S&P 500 Chat Functionality ====================
          
          const sp500QuestionEl = document.getElementById('sp500-question')
          const sp500AskBtn = document.getElementById('sp500-ask-btn')
          const sp500ResponseEl = document.getElementById('sp500-response')
          let chatMiniChart = null
          let chatLiveInterval = null
          
          // Initialize chat tab when shown
          function initChatTab() {
            loadChatLiveData()
            
            // Auto-refresh every 2 minutes for faster updates
            if (chatLiveInterval) clearInterval(chatLiveInterval)
            chatLiveInterval = setInterval(() => {
              loadChatLiveData()
            }, 120000)
          }
          
          // Load live ticker data for US markets only
          async function loadChatLiveData() {
            try {
              const res = await fetch('/api/market/live?range=5d')
              const data = await res.json()
              
              if (data.success && data.quote) {
                const quote = data.quote
                const price = quote.regularMarketPrice || 0
                const change = quote.regularMarketChangePercent || 0
                
                document.getElementById('live-sp500-price').textContent = price.toLocaleString(undefined, {minimumFractionDigits: 2})
                document.getElementById('live-sp500-change').innerHTML = `<span style="color:${change >= 0 ? '#10b981' : '#ef4444'}">${change >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(change).toFixed(2)}%</span>`
              }
              
              // Also fetch DOW and NASDAQ
              const indicesRes = await fetch('/api/market/indices')
              const indicesData = await indicesRes.json()
              
              if (indicesData.success && indicesData.indices) {
                const indices = indicesData.indices
                
                if (indices['^DJI']) {
                  const dow = indices['^DJI']
                  document.getElementById('live-dow-price').textContent = dow.price?.toLocaleString(undefined, {minimumFractionDigits: 2}) || '--'
                  const dowChange = dow.change_pct || 0
                  document.getElementById('live-dow-change').innerHTML = `<span style="color:${dowChange >= 0 ? '#10b981' : '#ef4444'}">${dowChange >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(dowChange).toFixed(2)}%</span>`
                }
                
                if (indices['^IXIC']) {
                  const nasdaq = indices['^IXIC']
                  document.getElementById('live-nasdaq-price').textContent = nasdaq.price?.toLocaleString(undefined, {minimumFractionDigits: 2}) || '--'
                  const nasdaqChange = nasdaq.change_pct || 0
                  document.getElementById('live-nasdaq-change').innerHTML = `<span style="color:${nasdaqChange >= 0 ? '#10b981' : '#ef4444'}">${nasdaqChange >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(nasdaqChange).toFixed(2)}%</span>`
                }
              }
              
              document.getElementById('chat-last-update').textContent = `Updated: ${new Date().toLocaleTimeString()}`
              
              // Load mini chart
              if (data.success && data.history) {
                loadChatMiniChart(data.history)
              }
            } catch (err) {
              console.error('Failed to load live data:', err)
            }
          }
          
          // Load mini chart for S&P 500
          function loadChatMiniChart(history) {
            try {
              if (!history || history.length === 0) return
              
              const ctx = document.getElementById('chat-mini-chart').getContext('2d')
              
              if (chatMiniChart) chatMiniChart.destroy()
              
              const prices = history.map(d => d.close)
              const labels = history.map(d => d.time || d.date)
              const isUp = prices[prices.length - 1] >= prices[0]
              
              chatMiniChart = new Chart(ctx, {
                type: 'line',
                data: {
                  labels: labels,
                  datasets: [{
                    data: prices,
                    borderColor: isUp ? '#10b981' : '#ef4444',
                    backgroundColor: isUp ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    borderWidth: 2
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: { legend: { display: false } },
                  scales: {
                    x: { display: false },
                    y: { display: false }
                  }
                }
              })
            } catch (err) {
              console.error('Failed to load mini chart:', err)
            }
          }
          
          sp500AskBtn.onclick = async () => {
            await askSP500Question(sp500QuestionEl.value)
          }
          
          // Auto-expand textarea (Task 4)
          sp500QuestionEl.addEventListener('input', function() {
            this.style.height = 'auto'
            this.style.height = Math.min(this.scrollHeight, 200) + 'px'
          })
          
          // Focus styling for textarea
          sp500QuestionEl.addEventListener('focus', function() {
            this.style.borderColor = '#0369a1'
            this.style.boxShadow = '0 0 0 3px rgba(3, 105, 161, 0.1)'
          })
          sp500QuestionEl.addEventListener('blur', function() {
            this.style.borderColor = '#e5e7eb'
            this.style.boxShadow = 'none'
          })
          
          // Enter = submit, Shift+Enter = new line (Task 4)
          sp500QuestionEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault()
              askSP500Question(sp500QuestionEl.value)
            }
          })
          
          // Track selected quick question (Task 3)
          let selectedQuickQuestion = null
          
          // Quick question buttons with selection state
          document.querySelectorAll('.quick-question').forEach(btn => {
            btn.addEventListener('click', async () => {
              // Clear previous selection
              document.querySelectorAll('.quick-question').forEach(b => {
                b.style.background = '#f8fafc'
                b.style.borderColor = '#e2e8f0'
                b.style.color = '#1e293b'
              })
              
              // Highlight selected
              btn.style.background = '#eff6ff'
              btn.style.borderColor = '#3b82f6'
              btn.style.color = '#1d4ed8'
              selectedQuickQuestion = btn
              
              // Auto-fill input
              sp500QuestionEl.value = btn.getAttribute('data-q')
              
              // Ask the question
              await askSP500Question(btn.getAttribute('data-q'))
            })
            
            // Hover effects
            btn.addEventListener('mouseenter', function() {
              if (this !== selectedQuickQuestion) {
                this.style.background = '#f1f5f9'
                this.style.borderColor = '#cbd5e1'
              }
            })
            btn.addEventListener('mouseleave', function() {
              if (this !== selectedQuickQuestion) {
                this.style.background = '#f8fafc'
                this.style.borderColor = '#e2e8f0'
              }
            })
          })
          
          // Chat history storage
          let chatHistory = []
          
          async function askSP500Question(question) {
            if (!question || !question.trim()) {
              return
            }
            
            // Hide empty state
            const emptyState = document.getElementById('sp500-empty-state')
            if (emptyState) emptyState.style.display = 'none'
            
            const responsesContainer = document.getElementById('sp500-responses')
            const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            
            // Add user question card
            const userCard = document.createElement('div')
            userCard.style.cssText = 'background:#eff6ff;border:1px solid #bfdbfe;border-radius:10px;padding:12px 14px;margin-bottom:12px'
            userCard.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                <span style="font-size:12px;font-weight:600;color:#1d4ed8">You asked</span>
                <span style="font-size:11px;color:#6b7280">${timestamp}</span>
              </div>
              <div style="font-size:14px;color:#1e40af">${escapeHtml(question)}</div>
            `
            responsesContainer.appendChild(userCard)
            
            // Add loading card
            const loadingCard = document.createElement('div')
            loadingCard.id = 'loading-card'
            loadingCard.style.cssText = 'background:white;border:1px solid #e5e7eb;border-radius:10px;padding:14px;margin-bottom:12px'
            loadingCard.innerHTML = `
              <div style="display:flex;align-items:center;gap:10px;color:#64748b">
                <span class="spinner"></span>
                <span style="font-size:13px">Analyzing your question with historical data...</span>
              </div>
            `
            responsesContainer.appendChild(loadingCard)
            
            // Scroll to bottom
            const conversation = document.getElementById('sp500-conversation')
            conversation.scrollTop = conversation.scrollHeight
            
            // Disable button while loading (Task 4)
            document.getElementById('ask-btn-icon').textContent = '‚è≥'
            document.getElementById('ask-btn-text').textContent = 'Analyzing...'
            sp500AskBtn.disabled = true
            sp500AskBtn.style.opacity = '0.7'
            sp500AskBtn.style.cursor = 'not-allowed'
            
            try {
              // Get LLM analysis
              const analysisRes = await fetch('/api/sp500/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: 'web-demo', question: question })
              })
              
              const analysisData = await analysisRes.json()
              
              // Remove loading card
              const loadingEl = document.getElementById('loading-card')
              if (loadingEl) loadingEl.remove()
              
              // Create response card with structured sections (Task 1)
              const responseCard = document.createElement('div')
              responseCard.style.cssText = 'background:white;border:1px solid #e5e7eb;border-radius:10px;margin-bottom:16px;overflow:hidden'
              
              if (analysisData.success) {
                const answer = analysisData.answer || 'No response generated.'
                const formattedResponse = formatStructuredResponse(answer, question)
                
                responseCard.innerHTML = `
                  <div style="padding:14px 16px;border-bottom:1px solid #f1f5f9">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                      <span style="font-size:12px;font-weight:600;color:#059669;display:flex;align-items:center;gap:6px">
                        <span>ü§ñ</span> AI Analysis
                      </span>
                      <span style="font-size:11px;color:#6b7280">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                  </div>
                  <div style="padding:0">
                    ${formattedResponse}
                  </div>
                  <!-- Trust Disclaimer (Task 6) -->
                  <div style="padding:10px 16px;background:#f8fafc;border-top:1px solid #f1f5f9;font-size:11px;color:#64748b;display:flex;align-items:center;gap:6px">
                    <span>‚ÑπÔ∏è</span> Educational insights based on historical data. Not financial advice.
                  </div>
                `
                
                // Save to history
                chatHistory.push({ question, answer, timestamp: new Date().toISOString() })
              } else {
                responseCard.innerHTML = `
                  <div style="padding:14px 16px">
                    <div style="color:#dc2626;font-size:14px;display:flex;align-items:center;gap:8px">
                      <span>‚ö†Ô∏è</span> ${analysisData.error || 'Unable to process your question. Please try again.'}
                    </div>
                  </div>
                `
              }
              
              responsesContainer.appendChild(responseCard)
              
              // Scroll to show new response
              conversation.scrollTop = conversation.scrollHeight
              
              // Get chart parameters
              const chartRes = await fetch('/api/sp500/chart-params', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: 'web-demo', question: question })
              })
              
              const chartData = await chartRes.json()
              
              if (chartData.success) {
                document.getElementById('suggested-chart').textContent = chartData.chart_type?.toUpperCase() || 'LINE CHART'
                document.getElementById('suggested-metrics').textContent = (chartData.metrics || ['sp500']).join(', ').toUpperCase()
              }
              
              // Clear input after successful submission
              sp500QuestionEl.value = ''
              sp500QuestionEl.style.height = '80px'
              
            } catch (err) {
              // Remove loading card
              const loadingEl = document.getElementById('loading-card')
              if (loadingEl) loadingEl.remove()
              
              // Show error
              const errorCard = document.createElement('div')
              errorCard.style.cssText = 'background:#fef2f2;border:1px solid #fecaca;border-radius:10px;padding:14px;margin-bottom:12px'
              errorCard.innerHTML = `<div style="color:#dc2626;font-size:14px">‚ö†Ô∏è Connection error: ${err.message}</div>`
              responsesContainer.appendChild(errorCard)
            } finally {
              document.getElementById('ask-btn-icon').textContent = 'üîç'
              document.getElementById('ask-btn-text').textContent = 'Analyze'
              sp500AskBtn.disabled = false
              sp500AskBtn.style.opacity = '1'
              sp500AskBtn.style.cursor = 'pointer'
            }
          }
          
          // Helper: Escape HTML to prevent XSS
          function escapeHtml(text) {
            const div = document.createElement('div')
            div.textContent = text
            return div.innerHTML
          }
          
          // Format response into structured sections (Task 1)
          function formatStructuredResponse(text, question) {
            // Parse the response into logical sections
            const sections = parseResponseSections(text)
            
            let html = ''
            
            // Summary section (always show)
            html += createCollapsibleSection('Summary', sections.summary || text.split('\n')[0] || 'Analysis complete.', 'üìã', true)
            
            // Observed Trends (if detected)
            if (sections.trends) {
              html += createCollapsibleSection('Observed Trends', sections.trends, 'üìà', true)
            }
            
            // Data Points (if numbers are present)
            if (sections.dataPoints) {
              html += createCollapsibleSection('Key Data Points', sections.dataPoints, 'üìä', true)
            }
            
            // Risk & Limitations
            html += createCollapsibleSection('Risk & Limitations', sections.risks || 'Past performance does not guarantee future results. Market conditions can change rapidly.', '‚ö†Ô∏è', false)
            
            // General Considerations
            html += createCollapsibleSection('General Considerations', sections.considerations || 'Consider your investment goals, risk tolerance, and time horizon before making decisions.', 'üí≠', false)
            
            return html
          }
          
          // Parse AI response into structured sections
          function parseResponseSections(text) {
            const sections = {
              summary: '',
              trends: '',
              dataPoints: '',
              risks: '',
              considerations: ''
            }
            
            // Simple heuristic parsing
            const lines = text.split('\n').filter(l => l.trim())
            const fullText = text
            
            // Extract summary (first paragraph or sentence)
            const firstPara = lines[0] || ''
            sections.summary = formatTextContent(firstPara)
            
            // Look for trend-related content
            const trendKeywords = /trend|growth|increase|decrease|rise|fall|up|down|momentum|pattern/i
            const trendLines = lines.filter(l => trendKeywords.test(l))
            if (trendLines.length > 0) {
              sections.trends = formatTextContent(trendLines.join(' '))
            }
            
            // Extract data points (lines with numbers/percentages)
            const dataLines = lines.filter(l => /\d+\.?\d*%|\$[\d,]+|\d{4}/.test(l))
            if (dataLines.length > 0) {
              sections.dataPoints = formatTextContent(dataLines.slice(0, 5).join('\n'))
            }
            
            // If no structured content found, use the full text as summary
            if (!sections.trends && !sections.dataPoints && lines.length > 1) {
              sections.summary = formatTextContent(lines.slice(0, 3).join(' '))
              if (lines.length > 3) {
                sections.trends = formatTextContent(lines.slice(3).join(' '))
              }
            }
            
            return sections
          }
          
          // Create collapsible section HTML
          function createCollapsibleSection(title, content, icon, expanded) {
            const sectionId = 'section-' + title.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now()
            
            return `
              <div class="analysis-section" style="border-bottom:1px solid #f1f5f9">
                <button onclick="toggleSection('${sectionId}')" style="width:100%;padding:12px 16px;background:none;border:none;cursor:pointer;display:flex;align-items:center;justify-content:space-between;text-align:left">
                  <span style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:600;color:#374151">
                    <span>${icon}</span> ${title}
                  </span>
                  <span id="${sectionId}-toggle" style="color:#9ca3af;font-size:12px;transition:transform 0.2s">${expanded ? '‚ñº' : '‚ñ∂'}</span>
                </button>
                <div id="${sectionId}" style="padding:0 16px 14px 40px;font-size:13px;color:#4b5563;line-height:1.6;display:${expanded ? 'block' : 'none'}">
                  ${content}
                </div>
              </div>
            `
          }
          
          // Toggle section visibility
          window.toggleSection = function(sectionId) {
            const section = document.getElementById(sectionId)
            const toggle = document.getElementById(sectionId + '-toggle')
            if (section.style.display === 'none') {
              section.style.display = 'block'
              toggle.textContent = '‚ñº'
            } else {
              section.style.display = 'none'
              toggle.textContent = '‚ñ∂'
            }
          }
          
          // Format text content with styling
          function formatTextContent(text) {
            if (!text) return '<span style="color:#9ca3af;font-style:italic">No specific data available.</span>'
            
            let formatted = text
              .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
              .replace(/\n/g, '<br>')
              .replace(/^[-‚Ä¢]\s*/gm, '')
              .split('<br>')
              .filter(l => l.trim())
              .map(l => l.trim())
              .join('</li><li style="margin-bottom:4px">')
            
            // If multiple items, wrap in list
            if (formatted.includes('</li>')) {
              formatted = '<ul style="margin:0;padding-left:16px"><li style="margin-bottom:4px">' + formatted + '</li></ul>'
            }
            
            // Highlight numbers and percentages
            formatted = formatted.replace(/(\d+\.?\d*%)/g, '<span style="color:#0369a1;font-weight:600">$1</span>')
            formatted = formatted.replace(/\$(\d+[\d,]*\.?\d*)/g, '<span style="color:#059669;font-weight:600">$$1</span>')
            
            return formatted
          }
          
          // Legacy format function (kept for compatibility)
          function formatAnalysisResponse(text) {
            let formatted = text
              .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
              .replace(/\n\n/g, '</p><p style="margin:12px 0">')
              .replace(/\n/g, '<br>')
              .replace(/- /g, '‚Ä¢ ')
            
            formatted = formatted.replace(/(\d+\.?\d*%)/g, '<span style="color:#2563eb;font-weight:600">$1</span>')
            formatted = formatted.replace(/\$(\d+[\d,]*\.?\d*)/g, '<span style="color:#10b981;font-weight:600">$$1</span>')
            
            return `<p style="margin:0">${formatted}</p>`
          }
        </script>
      </div>
    </div>
  </body>
</html>
